#!/usr/bin/env sh

set -eu

if test "$1" = ""; then
    echo "Missing argument, e.g. retail/Fastbind" >&2
    exit 1
fi

if ! test -d "$1"; then
    echo "$1 does not exist" >&2
    exit 1
fi

# if ! git diff --quiet; then
#     echo "The working tree is dirty, please clean up" >&2
#     exit 1
# fi

mode="$(dirname "$1")"
name="$(basename "$1")"
version="$(grep -Po "Version: \K.+" "$1/$name.toc")"
tag="$(echo "$mode/$name/$version" | tr "[:upper:]" "[:lower:]")"

git tag "$tag"
git archive --format=zip -o "$mode/$name-$version.zip" --prefix="$1" HEAD .