#!/usr/bin/env bash

set -euo pipefail

if test -z "$*"; then
    echo "Missing argument, e.g. $0 classic/Fastbind" >&2
    exit 1
fi

if ! test -d "$1"; then
    echo "$1 is not a directory" >&2
    exit 1
fi

platform="$(dirname "$1")"
name="$(basename "$1")"
toc="$platform/$name/$name.toc"
version="$(grep -Po "Version: \K.+" "$toc")"

if ! test -f "$toc"; then
    echo "$toc is not a file" >&2
    exit 1
fi

tag="$platform/$name/$version"

if git tag "$tag" > /dev/null 2>&1; then
    git push --tags
else
    echo "Tag $tag already exists." >&2
fi